---
phase: 10-performance-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content.config.ts
  - src/layouts/ArticleLayout.astro
  - src/components/ArticleCard.astro
  - src/components/RelatedArticles.astro
autonomous: true

must_haves:
  truths:
    - "Images in content collections are automatically optimized to WebP"
    - "Images use native lazy loading by default"
    - "Above-the-fold hero images use priority loading"
    - "All images have proper dimensions to prevent CLS"
  artifacts:
    - path: "src/content.config.ts"
      provides: "image() helper for schema validation and optimization"
      contains: "image()"
    - path: "src/layouts/ArticleLayout.astro"
      provides: "Hero image rendering with Image component and priority"
      contains: "import { Image } from 'astro:assets'"
    - path: "src/components/ArticleCard.astro"
      provides: "Thumbnail image rendering with lazy loading"
      contains: "import { Image } from 'astro:assets'"
  key_links:
    - from: "src/content.config.ts"
      to: "astro:assets image() helper"
      via: "schema callback function"
      pattern: "schema:\\s*\\(\\{\\s*image\\s*\\}\\)"
    - from: "src/layouts/ArticleLayout.astro"
      to: "content collection image data"
      via: "Image component with ImageMetadata"
      pattern: "<Image[^>]*src=\\{.*image"
---

<objective>
Enable Astro's built-in image optimization pipeline by updating content schemas to use the image() helper and updating components to use the Image component.

Purpose: Meet PERF-01 (lazy loading), PERF-02 (WebP format), and PERF-03 (optimized sizes) requirements through Astro's native image optimization.

Output: Content collections and components ready to render optimized images with automatic WebP conversion, responsive srcset, and lazy loading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-performance-optimization/10-RESEARCH.md
@src/content.config.ts
@src/layouts/ArticleLayout.astro
@src/components/ArticleCard.astro
@src/components/RelatedArticles.astro
@astro.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update content schema to use image() helper</name>
  <files>src/content.config.ts</files>
  <action>
Update the content schema to use Astro's image() helper instead of z.string() for image fields. This enables build-time optimization.

1. Change the articleSchema from a plain object to a function that receives { image } parameter
2. Replace `image: z.string().optional()` with `image: image().optional()`
3. Add `imageAlt: z.string().optional()` field for accessibility
4. Update the authors schema similarly - change to function form and use `image: image()` for author photos

The schema function form looks like:
```typescript
const articleSchema = ({ image }) => z.object({
  // ... existing fields
  image: image().optional(),
  imageAlt: z.string().optional(),
});
```

For collections, pass the schema function:
```typescript
const trainer = defineCollection({
  loader: glob({ pattern: '**/*.md', base: './src/content/trainer' }),
  schema: articleSchema,  // Pass function, not call it
});
```

IMPORTANT: The image() helper returns ImageMetadata type at runtime, not a string. Components receiving this data must handle ImageMetadata.
  </action>
  <verify>Run `npm run build` - build should succeed with no schema validation errors</verify>
  <done>Content collections use image() helper; existing articles without images still validate; schema ready for optimized images</done>
</task>

<task type="auto">
  <name>Task 2: Update ArticleLayout to render optimized hero image</name>
  <files>src/layouts/ArticleLayout.astro</files>
  <action>
Update ArticleLayout.astro to render featured images using Astro's Image component with priority loading for above-the-fold display.

1. Add import: `import { Image } from 'astro:assets';`
2. Add `import type { ImageMetadata } from 'astro';`
3. Change Props interface:
   - `image?: string` becomes `image?: ImageMetadata`
   - Add `imageAlt?: string`
4. After the header and before article-content div, add hero image rendering:

```astro
{image && (
  <div class="mb-8">
    <Image
      src={image}
      alt={imageAlt || title}
      width={1200}
      height={630}
      priority
      class="w-full rounded-lg"
    />
  </div>
)}
```

The `priority` attribute sets loading="eager", decoding="sync", and fetchpriority="high" for LCP optimization.

5. Update the articleSchema JSON-LD to handle ImageMetadata:
   - For og:image, image metadata has a .src property that is the processed URL
   - Use `image?.src` or fallback to default

Note: Layout is constrained globally via astro.config.mjs, so responsive srcset is automatic.
  </action>
  <verify>Run `npm run build` - no TypeScript errors; inspect built HTML for Image component output</verify>
  <done>ArticleLayout renders hero images with priority loading; Image component used for WebP/responsive output</done>
</task>

<task type="auto">
  <name>Task 3: Update ArticleCard and RelatedArticles for thumbnail images</name>
  <files>src/components/ArticleCard.astro, src/components/RelatedArticles.astro</files>
  <action>
Update card components to render thumbnail images with lazy loading (default behavior).

**ArticleCard.astro:**
1. Add import: `import { Image } from 'astro:assets';`
2. Destructure `image` and `imageAlt` from article.data alongside existing fields
3. Add conditional image rendering before the h2:

```astro
{image && (
  <Image
    src={image}
    alt={imageAlt || title}
    width={400}
    height={225}
    class="w-full h-48 object-cover rounded-t-lg -mx-6 -mt-6 mb-4"
  />
)}
```

No `priority` attribute means default lazy loading (loading="lazy", decoding="async").

**RelatedArticles.astro:**
1. Add import: `import { Image } from 'astro:assets';`
2. In the article card rendering, add image before h3:

```astro
{article.data.image && (
  <Image
    src={article.data.image}
    alt={article.data.imageAlt || article.data.title}
    width={300}
    height={169}
    class="w-full h-32 object-cover rounded-t-lg -mx-4 -mt-4 mb-3"
  />
)}
```

Smaller dimensions (300x169) for thumbnails in related articles grid.
  </action>
  <verify>Run `npm run build` - build succeeds; check HTML output shows Image component markup</verify>
  <done>ArticleCard and RelatedArticles render images with lazy loading; consistent sizing for thumbnails</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   npm run build
   ```
   - Build completes without errors
   - No TypeScript type errors

2. Schema verification:
   - Existing articles without images still validate
   - Schema accepts ImageMetadata type

3. Component output inspection:
   - Run `npm run dev` and inspect network tab
   - Image requests should show WebP format (if browser supports)
   - Check srcset attribute present in img tags

4. Lighthouse preparation:
   - Components ready for image optimization
   - Priority loading configured for hero images
   - Lazy loading default for below-fold images
</verification>

<success_criteria>
- content.config.ts uses image() helper for all image fields
- ArticleLayout renders hero images with priority attribute
- ArticleCard renders thumbnails with default lazy loading
- RelatedArticles renders thumbnails with default lazy loading
- Build succeeds with no errors
- All existing content (without images) still validates and renders
</success_criteria>

<output>
After completion, create `.planning/phases/10-performance-optimization/10-01-SUMMARY.md`
</output>
