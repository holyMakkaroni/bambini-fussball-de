---
phase: 03-legal-compliance
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - bambini-fussball/package.json
  - bambini-fussball/astro.config.mjs
  - bambini-fussball/src/layouts/BaseLayout.astro
autonomous: true

must_haves:
  truths:
    - "Cookie consent banner appears on first visit"
    - "User can accept or reject cookies"
    - "User choice is remembered across page visits"
  artifacts:
    - path: "bambini-fussball/package.json"
      provides: "Cookie consent dependency"
      contains: "@jop-software/astro-cookieconsent"
    - path: "bambini-fussball/astro.config.mjs"
      provides: "Cookie consent integration config"
      contains: "astro-cookieconsent"
  key_links:
    - from: "bambini-fussball/astro.config.mjs"
      to: "@jop-software/astro-cookieconsent"
      via: "Astro integration"
      pattern: "integrations.*cookieconsent"
---

<objective>
Implement cookie consent banner using @jop-software/astro-cookieconsent for DSGVO compliance.

Purpose: German law requires explicit consent before setting non-essential cookies. While this static site currently has no analytics, the banner future-proofs for later additions and demonstrates compliance. Fulfills LEGAL-03.

Output: Cookie consent banner that appears on first visit, allows accept/reject with equal button weight, and remembers user choice.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-legal-compliance/03-01-SUMMARY.md
@bambini-fussball/src/layouts/BaseLayout.astro
@bambini-fussball/astro.config.mjs
@bambini-fussball/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cookie consent package</name>
  <files>bambini-fussball/package.json</files>
  <action>
Install the Astro cookie consent integration:

```bash
cd bambini-fussball && npm install @jop-software/astro-cookieconsent
```

This package wraps vanilla-cookieconsent v3.x with Astro integration, handling:
- Script injection
- SSR compatibility
- Configuration via Astro config

Do NOT install vanilla-cookieconsent separately - the integration includes it.
  </action>
  <verify>Run `npm ls @jop-software/astro-cookieconsent` in bambini-fussball/ - shows installed version</verify>
  <done>Cookie consent package installed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Configure cookie consent integration in Astro</name>
  <files>bambini-fussball/astro.config.mjs</files>
  <action>
Add cookie consent integration to astro.config.mjs:

1. Import the integration:
   import cookieconsent from "@jop-software/astro-cookieconsent";

2. Add to integrations array with German-language config:

```javascript
cookieconsent({
  guiOptions: {
    consentModal: {
      layout: "box",
      position: "bottom center",
      equalWeightButtons: true,  // March 2025 court ruling compliance
      flipButtons: false
    },
    preferencesModal: {
      layout: "box"
    }
  },
  categories: {
    necessary: {
      enabled: true,
      readOnly: true
    },
    analytics: {
      enabled: false  // Disabled by default - user must opt-in
    }
  },
  language: {
    default: "de",
    translations: {
      de: {
        consentModal: {
          title: "Cookie-Einstellungen",
          description: "Diese Website verwendet Cookies, um Ihre Praferenzen zu speichern. Sie konnen wahlen, welche Cookies Sie zulassen mochten.",
          acceptAllBtn: "Alle akzeptieren",
          acceptNecessaryBtn: "Nur notwendige",
          showPreferencesBtn: "Einstellungen"
        },
        preferencesModal: {
          title: "Cookie-Einstellungen",
          acceptAllBtn: "Alle akzeptieren",
          acceptNecessaryBtn: "Nur notwendige",
          savePreferencesBtn: "Einstellungen speichern",
          sections: [
            {
              title: "Notwendige Cookies",
              description: "Diese Cookies sind fur die Grundfunktionen der Website erforderlich.",
              linkedCategory: "necessary"
            },
            {
              title: "Analyse-Cookies",
              description: "Diese Cookies helfen uns zu verstehen, wie Besucher die Website nutzen.",
              linkedCategory: "analytics"
            }
          ]
        }
      }
    }
  }
})
```

3. Ensure integration is added AFTER existing integrations (tailwind, etc.)

IMPORTANT: equalWeightButtons: true is critical - March 2025 German court ruling requires accept/reject buttons to have equal visual weight.
  </action>
  <verify>Run `npm run build` in bambini-fussball/ - build succeeds without errors</verify>
  <done>Cookie consent integration configured in astro.config.mjs with German translations</done>
</task>

<task type="auto">
  <name>Task 3: Verify cookie consent functionality</name>
  <files>bambini-fussball/src/layouts/BaseLayout.astro</files>
  <action>
Verify the cookie consent banner works correctly:

1. The @jop-software/astro-cookieconsent integration auto-injects into all pages
   - No manual BaseLayout changes needed for basic functionality
   - Integration handles script injection via Astro integration hooks

2. Start dev server and test:
   - Clear browser cookies/localStorage for localhost
   - Visit http://localhost:4321/
   - Banner should appear at bottom center
   - Both "Alle akzeptieren" and "Nur notwendige" buttons should be visible
   - Click "Nur notwendige" - banner should dismiss
   - Refresh page - banner should NOT reappear (choice remembered)

3. Test preference persistence:
   - Open browser DevTools > Application > Cookies
   - Look for cc_cookie (consent stored here)
   - Or check localStorage for consent data

4. If banner doesn't appear, check:
   - Build output for cookie consent scripts
   - Browser console for JavaScript errors
   - Integration order in astro.config.mjs

NOTE: If the integration requires explicit component placement (check docs), add to BaseLayout:
- Import component from integration
- Place before closing body tag
  </action>
  <verify>
1. Clear cookies and visit http://localhost:4321/ - banner appears
2. Click "Nur notwendige" - banner dismisses
3. Refresh page - banner stays dismissed
4. Check DevTools shows consent cookie/localStorage
  </verify>
  <done>Cookie consent banner functional with accept/reject and persistence</done>
</task>

</tasks>

<verification>
1. Start dev server: `cd bambini-fussball && npm run dev`
2. Open incognito/private window (clean cookie state)
3. Visit http://localhost:4321/
4. Cookie banner appears at bottom with German text
5. Both buttons ("Alle akzeptieren" / "Nur notwendige") have equal visual weight
6. Click "Nur notwendige" - banner closes
7. Refresh page - banner does NOT reappear
8. Navigate to /impressum - banner still doesn't appear (choice persists)
9. Run `npm run build && npm run preview` - works in production build
</verification>

<success_criteria>
- Cookie consent banner appears on first visit
- Banner displays in German with correct translations
- "Alle akzeptieren" and "Nur notwendige" buttons have equal weight
- User can dismiss banner by clicking either button
- Choice persists across page navigations and refreshes
- Production build works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-legal-compliance/03-02-SUMMARY.md`
</output>
